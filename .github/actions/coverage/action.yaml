name: Generate coverage data

runs:
  using: composite
  steps:
    - name: Are we called from `main`?
      # This should only be called from the main branch of the repo.
      # If this workflow is somehow called from another branch, crash.
      if: github.ref_name != 'main'
      run: |
        echo "This workflow can only be called from the main branch."
        exit 1

    - name: Build project
      run: yarn build

    - name: Generate global coverage report
      run: yarn coverage

    - name: Generate individual coverage reports
      # This step does fail due to some packages missing tests.
      # This still generates the individual reports, and we want to go on.
      run: >
        yarn workspaces foreach
        --all --parallel
        run yarn coverage:package
        || true

    - name: Consolidate coverage reports
      run: yarn generate-unit-test-report

    - name: Commit and push changes
      run: |
        git add docs/coverage
        git commit -m "Update global coverage report"
        git add **/docs/coverage
        git commit -m "Update individual coverage reports"
