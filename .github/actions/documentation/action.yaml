name: Generate documentation
description: This re-generates the API documentation and pushes it.

runs:
  using: composite

  steps:
    - name: Are we called from `main`?
      # This should only be called from the main branch of the repo.
      # If this workflow is somehow called from another branch, crash.
      if: github.ref_name != 'main'
      shell: bash
      run: |
        echo "This workflow can only be called from the main branch."
        exit 1

    - name: Extract API documentation
      shell: bash
      run: yarn extract

    - name: Generate text documentation
      shell: bash
      run: yarn document

    - name: Stage changes
      shell: bash
      # Find in current directory.
      # If the name is "node_modules", skip it, don't look inside it;
      # or
      # If the name contains "docs/api", print it with \0 separator (shell glob expansion protection)
      # Feed that list to git, through xargs to handle the \0 separator.
      run: >
        find .
        -name node_modules -prune
        -o
        -wholename "./*docs/api/*" -print0
        | xargs -0 git add


    - name: Commit changes
      shell: bash
      # Documentation may stay stable for internal changes, so we allow empty commit.
      run: git commit --message="Update API documentation" --allow-empty
