import { Real, type Vector } from "@siteimprove/alfa-math";
import { test } from "@siteimprove/alfa-test";

import {
  ColorSpace,
  Cylindrical,
} from "../../../src/value/color/converters.js";

// Floating point arithmetic being what it is, we round numbers at 5 decimals
// to stabilize tests.
function roundRGB<S extends ColorSpace.ColorSpace>(
  value: ColorSpace.RGB<S>,
): ColorSpace.RGB<S> {
  return {
    space: value.space,
    linear: value.linear,
    components: value.components.map((c) => Real.round(c, 5)),
  };
}

test("hslToRgb() converts HSL color to RGB", (t) => {
  for (const [h, s, l, r, g, b] of [
    [0, 1, 1, 1, 1, 1],
    [0, 1, 0.5, 1, 0, 0],
    [120, 1, 0.5, 0, 1, 0],
    [240, 1, 0.5, 0, 0, 1],
    [60, 1, 0.5, 1, 1, 0],
    [180, 1, 0.5, 0, 1, 1],
    [300, 1, 0.5, 1, 0, 1],
    [0, 0, 0, 0, 0, 0],
    [0, 0, 0.5, 0.5, 0.5, 0.5],
    [0, 0, 1, 1, 1, 1],
  ] as const) {
    const source = `hsl(${h}, ${s * 100}%, ${l * 100}%)`;

    t.deepEqual(
      Cylindrical.hslToRgb(h, s, l),
      [r, g, b],
      `Failed to convert ${source} to RGB (${r}, ${g}, ${b})`,
    );
  }
});

test("hwbToRgb() converts HWB color to RGB", (t) => {
  for (const [h, w, b, r, g, bl] of [
    [0, 0, 0, 1, 0, 0],
    [120, 0, 0, 0, 1, 0],
    [240, 0, 0, 0, 0, 1],
    [60, 0, 0, 1, 1, 0],
    [180, 0, 0, 0, 1, 1],
    [300, 0, 0, 1, 0, 1],
    [0, 1, 0, 1, 1, 1],
    [0, 0.5, 0.5, 0.5, 0.5, 0.5],
    [0, 0.2, 0.3, 0.7, 0.2, 0.2],
  ] as const) {
    const source = `hwb(${h}, ${w * 100}%, ${b * 100}%)`;

    t.deepEqual(
      Cylindrical.hwbToRgb(h, w, b),
      [r, g, bl],
      `Failed to convert ${source} to RGB (${r}, ${g}, ${bl})`,
    );
  }
});

test("convertRGB() linearize RGB colors", (t) => {
  // Since convertRGB doesn't check the number of components, we can test a
  // bunch of values in one go when we don't use the matrices…
  const cases: Array<[ColorSpace.ColorSpace, Vector]> = [
    [
      "a98-rgb",
      [
        0, 0.006320933917507671, 0.029027662219974663, 0.07080684757744776,
        0.1333039049218824, 0.21775552814439456, 0.3251667049779579,
        0.4563906149739503, 0.6121723111134431, 0.7931754593999576, 1,
      ],
    ],
    [
      "display-p3",
      [
        0, 0.010022825574869039, 0.033104766570885055, 0.07323895587840543,
        0.13286832155381798, 0.21404114048223255, 0.31854677812509186,
        0.44798841244188325, 0.6038273388553378, 0.7874122893956172, 1.0,
      ],
    ],
    [
      "prophoto-rgb",
      [
        0, 0.015848931924611134, 0.05518918645844859, 0.11450336728854528,
        0.192179909437029, 0.2871745887492587, 0.3987238835693844,
        0.5262310526550318, 0.669209313658415, 0.8272495069561094, 1,
      ],
    ],
    [
      "rec2020",
      [
        0, 0.003981071705534974, 0.021012222435230144, 0.055602076551067074,
        0.11090317490482345, 0.18946457081379978, 0.29346951945813216,
        0.42484968054675043, 0.5853504664669779, 0.7765725275664881, 1,
      ],
    ],
    [
      "sRGB",
      [
        0, 0.010022825574869039, 0.033104766570885055, 0.07323895587840543,
        0.13286832155381798, 0.21404114048223255, 0.31854677812509186,
        0.44798841244188325, 0.6038273388553378, 0.7874122893956172, 1.0,
      ],
    ],
  ];

  for (const [space, expected] of cases) {
    const source = {
      space,
      linear: false,
      components: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1],
    };

    t.deepEqual(
      roundRGB(ColorSpace.convertRGB(source, { space, linear: true })),
      roundRGB({ space, linear: true, components: expected }),
      `Failed to linearize RGB color ${space}.`,
    );
  }
});

test("convertRGB() de-linearize RGB colors", (t) => {
  // Since convertRGB doesn't check the number of components, we can test a
  // bunch of values in one go when we don't use the matrices…
  const cases: Array<[ColorSpace.ColorSpace, Vector]> = [
    [
      "a98-rgb",
      [
        0, 0.3509886500088471, 0.48103147826312764, 0.5784201482666786,
        0.6592557425266524, 0.7296583817678015, 0.7927273402455737,
        0.8502859555675208, 0.9035128753395815, 0.9532213304117194, 1,
      ],
    ],
    [
      "display-p3",
      [
        0, 0.3491902126282938, 0.48452920448170694, 0.5838314900602575,
        0.6651850846308363, 0.7353569830524495, 0.7977377330312598,
        0.85430583154494, 0.9063317533440594, 0.9546871718858662,
        0.9999999999999999,
      ],
    ],
    [
      "prophoto-rgb",
      [
        0, 0.2782559402207124, 0.4089623530229582, 0.5122851987684007,
        0.6010660762800317, 0.6803950000871885, 0.7529232265121797,
        0.82024455397501, 0.8834075444455188, 0.9431465314595465, 1,
      ],
    ],
    [
      "rec2020",
      [
        0, 0.38311868495572876, 0.5114020895561203, 0.6055274787301019,
        0.6826398906453425, 0.7491535384383408, 0.8082822114040379,
        0.8619012621279053, 0.9112149320796772, 0.9570494520245179, 1,
      ],
    ],
    [
      "sRGB",
      [
        0, 0.3491902126282938, 0.48452920448170694, 0.5838314900602575,
        0.6651850846308363, 0.7353569830524495, 0.7977377330312598,
        0.85430583154494, 0.9063317533440594, 0.9546871718858662,
        0.9999999999999999,
      ],
    ],
  ];

  for (const [space, expected] of cases) {
    const source = {
      space,
      linear: true,
      components: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1],
    };

    t.deepEqual(
      roundRGB(ColorSpace.convertRGB(source, { space, linear: false })),
      roundRGB({ space, linear: false, components: expected }),
      `Failed to de-linearize RGB-linear color ${space}-linear.`,
    );
  }
});

test("convertRGB() converts between RGB color spaces", (t) => {
  // Since (de-)linearization is tested separately, we only convert between
  // linear colors.
  // Since we need to use the matrices, we can only test colors with 3 components.
  // Note that each component actually depends on all 3, so the regularity in
  // the tests cases is probably bad for entropy. This is likely good enough
  // given that we only test some linear transformations, so the chances of
  // only getting the right result only on a few points are low, especially
  // since the 3 input vectors form a basis of the space.
  const cases: Array<
    [
      source: ColorSpace.ColorSpace,
      a98: Vector,
      displayP3: Vector,
      prophoto: Vector,
      rec2020: Vector,
      sRGB: Vector,
      xyz: Vector,
      xyzd50: Vector,
      xyzd65: Vector,
    ]
  > = [
    [
      "a98-rgb",
      [0.1, 0.2, 0.3],
      [0.08499055818589812, 0.19535827013705814, 0.2925720034091992],
      [0.1406485483101461, 0.18918219903344635, 0.2879021063143498],
      [0.11678386101569663, 0.19152274968234123, 0.2911121189583624],
      [0.06016442560392217, 0.19999999999999998, 0.30429289892944733],
      [0.15124714574282072, 0.1777946483243462, 0.3142421676970983],
      [0.1468036942897046, 0.17520975447560314, 0.23754935299242586],
      [0.15124714574282072, 0.1777946483243462, 0.3142421676970983],
    ],
    [
      "a98-rgb",
      [0.4, 0.5, 0.6],
      [0.38499055818589806, 0.4953582701370581, 0.5925720034091992],
      [0.4406485483101462, 0.4891821990334464, 0.5879021063143498],
      [0.4167838610156966, 0.4915227496823412, 0.5911121189583625],
      [0.36016442560392226, 0.4999999999999999, 0.6042928989294473],
      [0.4363839238583222, 0.4777946483243462, 0.6409594929250617],
      [0.436092397218575, 0.47520975447560315, 0.4850807337455639],
      [0.4363839238583222, 0.4777946483243462, 0.6409594929250617],
    ],
    [
      "a98-rgb",
      [0.7, 0.8, 0.9],
      [0.6849905581858978, 0.7953582701370581, 0.8925720034091993],
      [0.7406485483101463, 0.7891821990334464, 0.8879021063143498],
      [0.7167838610156965, 0.7915227496823413, 0.8911121189583625],
      [0.6601644256039221, 0.7999999999999998, 0.9042928989294474],
      [0.7215207019738236, 0.7777946483243462, 0.9676768181530253],
      [0.7253811001474451, 0.7752097544756033, 0.732612114498702],
      [0.7215207019738236, 0.7777946483243462, 0.9676768181530253],
    ],
    [
      "display-p3",
      [0.11359948625259517, 0.20420569547096884, 0.3073626899610168],
      [0.1, 0.2, 0.3],
      [0.15226957756246257, 0.1947727434704007, 0.295179036479282],
      [0.129373656222394, 0.196673508225759, 0.29848189634079464],
      [0.07750598237194398, 0.20420569547096884, 0.3117911154731301],
      [0.16125581906894898, 0.18503123500239968, 0.32220598704207326],
      [0.1570584161288614, 0.18253768146181087, 0.24355358156365867],
      [0.16125581906894898, 0.18503123500239968, 0.32220598704207326],
    ],
    [
      "display-p3",
      [0.4135994862525952, 0.5042056954709688, 0.6073626899610167],
      [0.4, 0.5, 0.6],
      [0.4522695775624627, 0.4947727434704007, 0.5951790364792819],
      [0.42937365622239393, 0.496673508225759, 0.5984818963407946],
      [0.3775059823719439, 0.5042056954709688, 0.6117911154731301],
      [0.4463925971844505, 0.48503123500239975, 0.6489233122700369],
      [0.4463471190577318, 0.482537681461811, 0.4910849623167968],
      [0.4463925971844505, 0.48503123500239975, 0.6489233122700369],
    ],
    [
      "display-p3",
      [0.7135994862525951, 0.804205695470969, 0.9073626899610168],
      [0.7, 0.8, 0.9],
      [0.7522695775624628, 0.7947727434704007, 0.895179036479282],
      [0.7293736562223939, 0.796673508225759, 0.8984818963407947],
      [0.6775059823719438, 0.804205695470969, 0.9117911154731301],
      [0.731529375299952, 0.7850312350023998, 0.9756406374980006],
      [0.7356358219866022, 0.782537681461811, 0.7386163430699351],
      [0.731529375299952, 0.7850312350023998, 0.9756406374980006],
    ],
    [
      "prophoto-rgb",
      [0.039015658061183706, 0.2225908922075996, 0.3131507910429748],
      [0.011462040106876195, 0.21406982574325997, 0.30420209220560634],
      [0.1, 0.2, 0.3],
      [0.06562493946664069, 0.20592652015205562, 0.30296992463006844],
      [-0.03411259090998592, 0.2225908922075996, 0.3170384359705871],
      [0.12274664539017674, 0.17482410561810652, 0.3272274749591625],
      [0.11621724420868851, 0.17120151081193244, 0.24753138075313807],
      [0.12274664539017674, 0.17482410561810652, 0.3272274749591625],
    ],
    [
      "prophoto-rgb",
      [0.3390156580611836, 0.5225908922075997, 0.6131507910429748],
      [0.31146204010687606, 0.5140698257432599, 0.6042020922056064],
      [0.4, 0.5, 0.6],
      [0.36562493946664054, 0.5059265201520556, 0.6029699246300684],
      [0.26588740909001385, 0.5225908922075997, 0.617038435970587],
      [0.4078834235056782, 0.47482410561810645, 0.653944800187126],
      [0.40550594713755883, 0.4712015108119324, 0.49506276150627615],
      [0.4078834235056782, 0.47482410561810645, 0.653944800187126],
    ],
    [
      "prophoto-rgb",
      [0.6390156580611834, 0.8225908922075996, 0.9131507910429748],
      [0.6114620401068755, 0.8140698257432598, 0.9042020922056063],
      [0.7, 0.8, 0.9],
      [0.6656249394666403, 0.8059265201520557, 0.9029699246300684],
      [0.5658874090900132, 0.8225908922075996, 0.9170384359705872],
      [0.6930202016211796, 0.7748241056181066, 0.9806621254150896],
      [0.6947946500664292, 0.7712015108119324, 0.7425941422594142],
      [0.6930202016211796, 0.7748241056181066, 0.9806621254150896],
    ],
    [
      "rec2020",
      [0.07935462658705761, 0.21162010519172214, 0.30948672729905],
      [0.05950231653574714, 0.20548069897296645, 0.30139549200010923],
      [0.12807564851544967, 0.19630151010317287, 0.2968351924779756],
      [0.1, 0.2, 0.3],
      [0.026665913457168056, 0.21162010519172214, 0.31368804247178184],
      [0.14328347809662245, 0.17966015044585948, 0.3239100559230548],
      [0.1380158839208247, 0.1766563983968649, 0.24492008350065606],
      [0.14328347809662245, 0.17966015044585948, 0.3239100559230548],
    ],
    [
      "rec2020",
      [0.37935462658705765, 0.5116201051917221, 0.60948672729905],
      [0.35950231653574716, 0.5054806989729664, 0.6013954920001092],
      [0.42807564851544977, 0.49630151010317297, 0.5968351924779756],
      [0.4, 0.5, 0.6],
      [0.32666591345716806, 0.5116201051917221, 0.6136880424717819],
      [0.428420256212124, 0.47966015044585947, 0.6506273811510183],
      [0.4273045868496951, 0.4766563983968649, 0.4924514642537941],
      [0.428420256212124, 0.47966015044585947, 0.6506273811510183],
    ],
    [
      "rec2020",
      [0.6793546265870576, 0.8116201051917221, 0.90948672729905],
      [0.659502316535747, 0.8054806989729664, 0.9013954920001093],
      [0.7280756485154498, 0.7963015101031731, 0.8968351924779756],
      [0.7, 0.8, 0.9],
      [0.6266659134571678, 0.8116201051917221, 0.9136880424717819],
      [0.7135570343276255, 0.7796601504458595, 0.977344706378982],
      [0.7165932897785654, 0.776656398396865, 0.7399828450069323],
      [0.7135570343276255, 0.7796601504458595, 0.977344706378982],
    ],
    [
      "sRGB",
      [0.1284874393144376, 0.2, 0.2958838051549882],
      [0.11775380312856379, 0.1966805801149038, 0.28934372978937967],
      [0.16112915427762847, 0.192979756801214, 0.28485899039011053],
      [0.1415909169752718, 0.1942265026208077, 0.28792038143724735],
      [0.1, 0.2, 0.3],
      [0.16690018432392184, 0.18595533094892236, 0.3109316835053826],
      [0.16356040259500051, 0.18381266326843876, 0.23503846403736323],
      [0.16690018432392184, 0.18595533094892236, 0.3109316835053826],
    ],
    [
      "sRGB",
      [0.4284874393144377, 0.5, 0.5958838051549882],
      [0.4177538031285638, 0.49668058011490374, 0.5893437297893798],
      [0.4611291542776286, 0.4929797568012139, 0.5848589903901106],
      [0.4415909169752718, 0.49422650262080764, 0.5879203814372473],
      [0.4, 0.5, 0.6],
      [0.4520369624394233, 0.48595533094892235, 0.6376490087333462],
      [0.45284910552387087, 0.48381266326843875, 0.48256984479050136],
      [0.4520369624394233, 0.48595533094892235, 0.6376490087333462],
    ],
    [
      "sRGB",
      [0.7284874393144376, 0.8, 0.8958838051549881],
      [0.7177538031285637, 0.7966805801149037, 0.8893437297893797],
      [0.7611291542776287, 0.792979756801214, 0.8848589903901106],
      [0.7415909169752717, 0.7942265026208077, 0.8879203814372474],
      [0.7, 0.8, 0.9],
      [0.7371737405549248, 0.7859553309489224, 0.9643663339613098],
      [0.7421378084527411, 0.7838126632684389, 0.7301012255436395],
      [0.7371737405549248, 0.7859553309489224, 0.9643663339613098],
    ],
    [
      "xyz",
      [-0.012262009708196145, 0.2907356538956088, 0.282224447934361],
      [-0.05774026772489732, 0.2766713208600949, 0.27541546237307624],
      [0.06523401185740511, 0.24880818945012023, 0.2759032224147535],
      [0.024521077629750407, 0.2613583758879123, 0.2758407994636115],
      [-0.13296286941146754, 0.2907356538956088, 0.2818590704647676],
      [0.1, 0.2, 0.3],
      [0.09432467348806005, 0.19592752650875597, 0.2276490186618803],
      [0.1, 0.2, 0.3],
    ],
    [
      "xyz",
      [0.32729286391787105, 0.5752193306858137, 0.5553015127720264],
      [0.290080485146578, 0.5637112538397094, 0.5503828518681052],
      [0.38880460191125815, 0.5405318947599255, 0.5513906321202248],
      [0.3568053144761153, 0.5510280050728207, 0.5509325090905043],
      [0.2285299318009602, 0.5752193306858137, 0.5544464609800364],
      [0.4, 0.5, 0.6],
      [0.40052999254528043, 0.49682405744691105, 0.4549549483435495],
      [0.4, 0.5, 0.6],
    ],
    [
      "xyz",
      [0.6668477375439382, 0.8597030074760187, 0.828378577609692],
      [0.6379012380180529, 0.850751186819324, 0.8253502413631342],
      [0.7123751919651111, 0.832255600069731, 0.8268780418256961],
      [0.68908955132248, 0.8406976342577289, 0.8260242187173972],
      [0.5900227330133874, 0.8597030074760187, 0.8270338514953051],
      [0.7, 0.8, 0.9],
      [0.7067353116025007, 0.7977205883850663, 0.6822608780252187],
      [0.7, 0.8, 0.9],
    ],
    [
      "xyz-d50",
      [-0.028309193883428105, 0.29540418984072997, 0.3794097251027538],
      [-0.0768967658579659, 0.2803782890380662, 0.3674437528551594],
      [0.06813371119609332, 0.2533447122874656, 0.3635902636916835],
      [0.015194219294362335, 0.2651216368226797, 0.36644905443530873],
      [-0.15726227968692608, 0.29540418984072997, 0.3830159978266938],
      [0.10990542411922577, 0.20547454104044968, 0.39623964949930557],
      [0.1, 0.2, 0.3],
      [0.10990542411922577, 0.20547454104044968, 0.39623964949930557],
    ],
    [
      "xyz-d50",
      [0.2748007854603693, 0.5866747221099031, 0.7504928514622513],
      [0.22799024840560833, 0.5721983764577094, 0.7347877492676994],
      [0.37986758998363884, 0.5485880578344655, 0.727180527383367],
      [0.3204572297099132, 0.5584819134363237, 0.7325392945581989],
      [0.15056401140436737, 0.5866747221099031, 0.757525398183459],
      [0.4085956870411901, 0.506274680022257, 0.7928913370416177],
      [0.4, 0.5, 0.6],
      [0.4085956870411901, 0.506274680022257, 0.7928913370416177],
    ],
    [
      "xyz-d50",
      [0.5779107648041663, 0.8779452543790767, 1.1215759778217487],
      [0.532877262669182, 0.8640184638773529, 1.1021317456802393],
      [0.6916014687711843, 0.8438314033814655, 1.0907707910750506],
      [0.625720240125464, 0.851842190049968, 1.0986295346810888],
      [0.45839030249566015, 0.8779452543790767, 1.132034798540224],
      [0.7072859499631543, 0.8070748190040644, 1.1895430245839298],
      [0.7, 0.8, 0.9],
      [0.7072859499631543, 0.8070748190040644, 1.1895430245839298],
    ],
    [
      "xyz-d65",
      [-0.012262009708196145, 0.2907356538956088, 0.282224447934361],
      [-0.05774026772489732, 0.2766713208600949, 0.27541546237307624],
      [0.06523401185740511, 0.24880818945012023, 0.2759032224147535],
      [0.024521077629750407, 0.2613583758879123, 0.2758407994636115],
      [-0.13296286941146754, 0.2907356538956088, 0.2818590704647676],
      [0.1, 0.2, 0.3],
      [0.09432467348806005, 0.19592752650875597, 0.2276490186618803],
      [0.1, 0.2, 0.3],
    ],
    [
      "xyz-d65",
      [0.32729286391787105, 0.5752193306858137, 0.5553015127720264],
      [0.290080485146578, 0.5637112538397094, 0.5503828518681052],
      [0.38880460191125815, 0.5405318947599255, 0.5513906321202248],
      [0.3568053144761153, 0.5510280050728207, 0.5509325090905043],
      [0.2285299318009602, 0.5752193306858137, 0.5544464609800364],
      [0.4, 0.5, 0.6],
      [0.40052999254528043, 0.49682405744691105, 0.4549549483435495],
      [0.4, 0.5, 0.6],
    ],
    [
      "xyz-d65",
      [0.6668477375439382, 0.8597030074760187, 0.828378577609692],
      [0.6379012380180529, 0.850751186819324, 0.8253502413631342],
      [0.7123751919651111, 0.832255600069731, 0.8268780418256961],
      [0.68908955132248, 0.8406976342577289, 0.8260242187173972],
      [0.5900227330133874, 0.8597030074760187, 0.8270338514953051],
      [0.7, 0.8, 0.9],
      [0.7067353116025007, 0.7977205883850663, 0.6822608780252187],
      [0.7, 0.8, 0.9],
    ],
  ];

  for (const [
    source,
    a98,
    displayP3,
    prophoto,
    rec2020,
    sRGB,
    xyz,
    xyzd50,
    xyzd65,
  ] of cases) {
    const values = {
      "a98-rgb": a98,
      "display-p3": displayP3,
      "prophoto-rgb": prophoto,
      rec2020,
      sRGB,
      xyz,
      "xyz-d50": xyzd50,
      "xyz-d65": xyzd65,
    } as const;

    const sourceColor = {
      space: source,
      linear: true,
      components: values[source],
    };

    for (const dest of Object.keys(values) as Array<ColorSpace.ColorSpace>) {
      t.deepEqual(
        roundRGB(
          ColorSpace.convertRGB(sourceColor, { space: dest, linear: true }),
        ),
        roundRGB({ space: dest, linear: true, components: values[dest] }),
        `Failed to convert ${source}(${values[source]}) (linear) to ${dest} (linear).`,
      );
    }
  }
});
